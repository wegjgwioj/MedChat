# -*- coding: utf-8 -*-
"""prompts.py

集中管理提示词，便于后续迭代与评测。

注意：
- 所有提示词都要求模型输出严格 JSON（抽取阶段）或严格遵循引用格式（回答阶段）。
- 不要在日志中打印完整用户输入，避免隐私泄漏。
"""

from __future__ import annotations

SLOT_EXTRACTION_SYSTEM = """你是严谨的医疗问诊信息抽取器。
你的任务：从用户本轮输入中抽取结构化槽位，输出严格 JSON。
约束：
- 只输出 JSON，不要解释，不要 Markdown。
- 不要捏造不存在的信息；不确定就填空/unknown。
- symptoms 请尽量用短词列表（如：咳嗽、发热、腹痛）。
"""

# 说明：Pydantic 校验会兜底，模型输出允许缺字段。
SLOT_EXTRACTION_USER_TEMPLATE = """请从以下患者输入中抽取槽位，输出 JSON。

JSON 字段：
- age: number|null
- sex: string
- symptoms: string[]
- duration: string
- severity: string
- fever: \"yes\"|\"no\"|\"unknown\"
- location: string
- pregnancy: \"yes\"|\"no\"|\"unknown\"
- meds: string
- allergy: string
- history: string
- red_flags: string[]
- department_guess: string|null

患者输入：{user_message}
"""

ANSWER_SYSTEM = """你是医疗问诊助手。
你必须遵循：
- 语言简洁、像医生。
- 如果有证据，请在正文中使用 [E1] [E2] 引用，并在末尾给出：引用：[E1][E2]。
- 必须附带安全免责声明。
- 不要编造不存在的证据；若未检索到资料，明确说明并给通用建议。
"""

ANSWER_USER_TEMPLATE = """用户问题：{user_message}

已知结构化信息（可能不完整）：
{summary}

本轮检索到的证据（每条以 E 开头）：
{evidence_block}

请生成：
1) 面向患者的回答（分点更易读）；
2) 文末写出引用列表：引用：[E1][E2]（按实际使用的编号填写；若无证据则写 引用：[]）。
3) 文末再写一段免责声明：本回答仅供信息参考，不能替代医生面诊。
"""

ESCALATE_ANSWER_TEMPLATE = """根据你的描述，存在可能的危险信号（{red_flags}）。
建议：
- 立即停止自行处理，尽快前往急诊或拨打当地急救电话。
- 如果你愿意补充：目前是否出现呼吸困难/胸痛加重/意识改变/抽搐/持续高热？（只需回答有/无）

免责声明：本回答仅供信息参考，不能替代医生面诊。
"""


# ==============================
# 自然追问模板库（用于 mode=ask）
# ==============================
# 设计目标：
# 1) 像医生：包含共情/解释为什么问/给答法示例
# 2) anti-repeat：每个槽位至少 3 种说法，便于换措辞
# 3) 前端可生成快捷回答/控件：提供 type/placeholder/choices/range


ASK_TEXT_VARIANTS = [
	"我明白你现在不舒服。为了更准确判断风险与下一步处理，我想再确认几个关键信息；不方便说也没关系。",
	"辛苦了。我需要补充 1-3 个关键信息来判断是否需要尽快就医；你可以只回答你愿意的部分。",
	"我先帮你把情况理清楚：再补充几项信息我就能给更具体的建议，不方便回答也可以跳过。",
]


# 每个槽位的结构化追问定义
# - question_variants：自然问句（至少 3 条）
# - type：text/enum/number
# - placeholder：text 输入提示
# - choices：enum 快捷选项
# - range：number 的范围（例如 0-10）


FOLLOW_UP_BANK = {
	"age": {
		"type": "text",
		"placeholder": "例如：24岁 / 20多 / 不确定",
		"question_variants": [
			"方便说一下你的年龄或大概年龄段吗？我想判断一些情况是否更需要警惕。（例如：24岁/20多）",
			"为了评估风险，我需要知道你的年龄大概是多少。你可以说年龄段也行。（例如：30岁/30多）",
			"我想再确认一下：你大概多少岁？这会影响判断与建议。（例如：18岁/40多）",
		],
	},
	"sex": {
		"type": "enum",
		"choices": ["男", "女", "不便透露"],
		"question_variants": [
			"我再确认一下你的性别（有些症状评估会不同）。你可以直接选：男/女/不便透露。",
			"方便告诉我你的性别吗？这有助于更贴合地判断。（男/女/不便透露）",
			"为了避免给出不合适的建议，我想确认性别：男、女，或者不便透露都可以。",
		],
	},
	"symptoms": {
		"type": "text",
		"placeholder": "例如：头痛、恶心、咳嗽（列1-3个）",
		"question_variants": [
			"你现在最主要的 1-3 个不适是什么？我先抓重点来判断。（例如：头痛、恶心）",
			"为了更快定位问题，你能用几个关键词说说最困扰你的症状吗？（例如：头痛/畏光/恶心）",
			"我先确认一下：目前最明显的症状是哪几个？（列 1-3 个就行，例如：头痛、呕吐）",
		],
	},
	"duration": {
		"type": "text",
		"placeholder": "例如：2小时 / 3天 / 一周左右",
		"question_variants": [
			"这些不舒服大概持续多久了？我需要区分急性还是持续性。（例如：2小时/3天）",
			"为了判断严重程度和可能原因，你能说下症状从什么时候开始、持续了多久吗？（例如：昨晚开始/两天）",
			"我再问一句：症状大概多久了？（比如：今天才出现/两天/一周）",
		],
	},
	"severity": {
		"type": "number",
		"range": [0, 10],
		"question_variants": [
			"现在大概有多难受？如果方便，用 0-10 分打个分（0=不影响，10=最严重），我好判断紧急程度。",
			"为了判断是否需要尽快就医，你能给症状严重程度打分吗？（0-10 分都可以）",
			"我想了解一下强度：0 到 10 分你会给几分？（例如：6分）",
		],
	},
	"fever": {
		"type": "enum",
		"choices": ["有", "没有", "不确定"],
		"question_variants": [
			"这两天有发烧或测到体温升高吗？（有/没有/不确定）这会影响判断是否感染相关。",
			"方便确认下有没有发热吗？（有/没有/不确定）例如体温 38℃ 以上。",
			"我再确认：最近有没有发烧？没有测也没关系，按感觉回答也行。（有/没有/不确定）",
		],
	},
	"location": {
		"type": "text",
		"placeholder": "例如：头部一侧/太阳穴/后枕部",
		"question_variants": [
			"不舒服主要在什么部位？定位能帮助缩小原因。（例如：太阳穴/后枕部/全头）",
			"为了更准确判断，你能说下疼痛或不适的部位吗？（例如：左侧太阳穴）",
			"我想确认一下位置：主要是哪里不舒服？（例如：头顶/额头/后颈）",
		],
	},
	"pregnancy": {
		"type": "enum",
		"choices": ["有", "没有", "不确定", "不适用"],
		"question_variants": [
			"如果适用的话，我想确认是否可能怀孕/备孕？这会影响用药与建议。（有/没有/不确定/不适用）",
			"我需要确认一下是否有怀孕可能（如适用）。不方便说也可以选“不适用”。",
			"为了避免不合适的建议：是否可能怀孕？（有/没有/不确定/不适用）",
		],
	},
	"meds": {
		"type": "text",
		"placeholder": "例如：布洛芬/对乙酰氨基酚/未用药",
		"question_variants": [
			"你这段时间有没有吃过什么药或用过什么处理？我想避免药物重复或相互影响。（例如：布洛芬/未用药）",
			"为了更安全地给建议，你最近有没有用药？（药名/大概剂量/没有用都可以）",
			"我再确认一下：目前有没有自行用药或处理？（例如：布洛芬、热敷、未用药）",
		],
	},
	"allergy": {
		"type": "text",
		"placeholder": "例如：青霉素过敏/无",
		"question_variants": [
			"你有没有已知的药物或食物过敏史？我主要是为了避免推荐到不安全的药。（例如：青霉素过敏/无）",
			"为了用药安全，想确认一下是否有过敏史？（有的话说一下；没有就说无）",
			"我再问一句：有没有明确过敏的东西或药？（例如：青霉素/海鲜/无）",
		],
	},
	"history": {
		"type": "text",
		"placeholder": "例如：高血压/偏头痛史/无",
		"question_variants": [
			"你有没有重要的既往病史（比如高血压、偏头痛、心脑血管病等）？这会影响风险判断。",
			"为了判断是否需要更谨慎处理，方便说下既往史吗？（例如：偏头痛史/无）",
			"我想确认一下：以前有类似情况或慢性病吗？（有就简要说；没有就说无）",
		],
	},
}


# ==============================
# M1 检索优化：DeepSeek 语义提纯
# ==============================
# 用于将患者口语化描述转化为医学关键词，提升检索精度

QUERY_SLIMMING_SYSTEM = """你是一个专业的医疗信息提取助手。
你的任务：将病人零散、多余的口语化描述转化为核心医学关键词，以便在知识库中进行精准检索。
约束：
- 仅输出提取到的核心症状、身体部位或伴随症状、症状时间。
- 关键词之间用空格隔开。
- 不要输出任何解释、标点符号或开场白。
"""

QUERY_SLIMMING_USER_TEMPLATE = """请从以下患者输入中提取检索关键词。

患者输入：{user_message}
提取结果："""
